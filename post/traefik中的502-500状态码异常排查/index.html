<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Traefik中的502-500状态码异常排查 - CloudNativeOps - SRE，DevOps、Kubernetes 云原生运维。成长之路，一起前行！</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="BGBiao" />
  <meta name="description" content=" 我们都知道在Kubernetes集群中通常会使用Ingress方案来统一代理集群内部的流量，而常用的Ingress方案为traefik和nginx，和传统的Nginx作为企业内部的反向代理以及负载设备一样，在不同的场景下可能需要专有的配置才能满足需求，否则会出现奇奇怪怪的异常状态码。本篇文章一起来看下，我们在traefik中遇到的500和502异常。
" />

  <meta name="keywords" content="SRE, Ops, DevOps, Kubernetes, Docker, CloudNative" />






<meta name="generator" content="Hugo 0.103.1" />


<link rel="canonical" href="https://bgbiao.top/post/traefik%E4%B8%AD%E7%9A%84502-500%E7%8A%B6%E6%80%81%E7%A0%81%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.444f741ba7b684e63dff9a3b61ec1fb750c9b563b5a0b64153f1af8025c5fac1.css" integrity="sha256-RE90G6e2hOY9/5o7Yewft1DJtWO1oLZBU/GvgCXF&#43;sE=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="Traefik中的502-500状态码异常排查" />
<meta property="og:description" content="
我们都知道在Kubernetes集群中通常会使用Ingress方案来统一代理集群内部的流量，而常用的Ingress方案为traefik和nginx，和传统的Nginx作为企业内部的反向代理以及负载设备一样，在不同的场景下可能需要专有的配置才能满足需求，否则会出现奇奇怪怪的异常状态码。本篇文章一起来看下，我们在traefik中遇到的500和502异常。
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bgbiao.top/post/traefik%E4%B8%AD%E7%9A%84502-500%E7%8A%B6%E6%80%81%E7%A0%81%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-06-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-11-01T17:14:34+08:00" />

<meta itemprop="name" content="Traefik中的502-500状态码异常排查">
<meta itemprop="description" content="
我们都知道在Kubernetes集群中通常会使用Ingress方案来统一代理集群内部的流量，而常用的Ingress方案为traefik和nginx，和传统的Nginx作为企业内部的反向代理以及负载设备一样，在不同的场景下可能需要专有的配置才能满足需求，否则会出现奇奇怪怪的异常状态码。本篇文章一起来看下，我们在traefik中遇到的500和502异常。
"><meta itemprop="datePublished" content="2020-06-28T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-11-01T17:14:34+08:00" />
<meta itemprop="wordCount" content="4835">
<meta itemprop="keywords" content="traefik,kubernetes,http,状态码异常," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Traefik中的502-500状态码异常排查"/>
<meta name="twitter:description" content="
我们都知道在Kubernetes集群中通常会使用Ingress方案来统一代理集群内部的流量，而常用的Ingress方案为traefik和nginx，和传统的Nginx作为企业内部的反向代理以及负载设备一样，在不同的场景下可能需要专有的配置才能满足需求，否则会出现奇奇怪怪的异常状态码。本篇文章一起来看下，我们在traefik中遇到的500和502异常。
"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-151318936-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">BGBiao的SRE人生</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/post/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          <div class="mobile-menu-parent">
            <span class="mobile-submenu-open"></span>
            <a href="https://bgbiao.top/">
              学习文档
            </a>
          </div>
          <ul class="mobile-submenu-list">
            
              <li>
                <a href="https://otexts.com/fppcn/index.html">&lt;预测:方法与实践&gt;</a>
              </li>
            
          </ul>
        
      </li><li class="mobile-menu-item">
        
          
          <div class="mobile-menu-parent">
            <span class="mobile-submenu-open"></span>
            <a href="https://bgbiao.top/">
              Golang相关
            </a>
          </div>
          <ul class="mobile-submenu-list">
            
              <li>
                <a href="https://gowebexamples.com/">Golang web开发示例</a>
              </li>
            
              <li>
                <a href="http://go-database-sql.org/">Golang SQL开发教程</a>
              </li>
            
              <li>
                <a href="https://rpcx.io/">Golang RPCX框架</a>
              </li>
            
              <li>
                <a href="https://github.com/talkgo/read">Golang 夜读</a>
              </li>
            
              <li>
                <a href="https://books.studygolang.com/">Golang 开源书籍</a>
              </li>
            
          </ul>
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/devops/">DevOps/SRE</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/books/">我的书单</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/about/">关于我</a>
          
        
      </li>
    

    
      <li class="mobile-menu-item">
        <a id="openSearchMobile" class="mobile-menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  
    
<div class="modal-dialog">
    
    <div class="modal-content">
      <div id="closeSearch" title="Close" class="close">X</div>
      <div class="modal-header">
        <div class="modal-title">Search</div>
      </div>
      <div class="modal-body">
          <script>
            (function() {
              var cx = '006410550977056989513:rg9ancg1smm';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = (document.location.protocol == 'https:' ? 'https:' :
                  'http:') +
                '//cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:search></gcse:search>
      </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      BGBiao的SRE人生
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/post/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          <a class="menu-item-link menu-parent" href="https://bgbiao.top/">学习文档</a>
          <ul class="submenu">
            
              <li>
                <a href="https://otexts.com/fppcn/index.html">&lt;预测:方法与实践&gt;</a>
              </li>
            
          </ul>

        

      </li>
    
        <li class="menu-item">
        
          
          <a class="menu-item-link menu-parent" href="https://bgbiao.top/">Golang相关</a>
          <ul class="submenu">
            
              <li>
                <a href="https://gowebexamples.com/">Golang web开发示例</a>
              </li>
            
              <li>
                <a href="http://go-database-sql.org/">Golang SQL开发教程</a>
              </li>
            
              <li>
                <a href="https://rpcx.io/">Golang RPCX框架</a>
              </li>
            
              <li>
                <a href="https://github.com/talkgo/read">Golang 夜读</a>
              </li>
            
              <li>
                <a href="https://books.studygolang.com/">Golang 开源书籍</a>
              </li>
            
          </ul>

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/devops/">DevOps/SRE</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/books/">我的书单</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bgbiao.top/about/">关于我</a>
          

        

      </li>
    

    
    

    
      <li class="menu-item">
        <a id="openSearch" class="menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Traefik中的502-500状态码异常排查</h1>
      
      <div class="post-meta">
        <time datetime="2020-06-28" class="post-time">
          2020-06-28
        </time>
        <div class="post-category">
            <a href="https://bgbiao.top/categories/%E8%BF%90%E7%BB%B4/"> 运维 </a>
            
          </div>
        <span class="more-meta"> 4835 words </span>
          <span class="more-meta"> 10 min read </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#一前言">一、前言</a></li>
        <li><a href="#二traefik中诡异的500和502">二、traefik中诡异的500和502</a></li>
        <li><a href="#三slb中诡异的503">三、SLB中诡异的503</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <blockquote>
<p>我们都知道在Kubernetes集群中通常会使用Ingress方案来统一代理集群内部的流量，而常用的Ingress方案为<a href="https://docs.traefik.io/">traefik</a>和<a href="https://github.com/kubernetes/ingress-nginx">nginx</a>，和传统的Nginx作为企业内部的反向代理以及负载设备一样，在不同的场景下可能需要专有的配置才能满足需求，否则会出现奇奇怪怪的异常状态码。本篇文章一起来看下，我们在<code>traefik</code>中遇到的500和502异常。</p>
</blockquote>
<h3 id="一前言">一、前言</h3>
<p>在开始之前，我们先来看几个在Nginx作为反向代理工具中经常遇到的几个异常状态码：</p>
<ul>
<li>499: 客户端主动断开连接。通常为一次请求未在客户端指定时间内返回，客户端主动关闭连接，客户端无数据返回(在Nginx中会记录499)。一般是<code>客户端超时</code></li>
<li>500: 服务器内部错误。服务器遇到未知错误导致无法完成请求处理，通常由于后端业务逻辑异常导致(本身Bug)</li>
<li>502: 网关错误。通常为网关未从上游服务中获取期望的响应(<code>上游未返回数据或未按照协议约定返回数据</code>)，网关感觉自己没用了，返回了网关错误。一般是<code>后端服务器宕机</code>或<code>业务逻辑超时</code></li>
<li>504: 网关超时。表示网关没有及时从上游获取响应数据。一般是Nginx网关作为客户端去向上游服务请求响应的过程中，Nginx网关超时导致，但此时对于上游服务器来将，它会继续执行，直到结束。(<code>Nginx网关作为客户端时的超时</code>)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 499 的实际情况就是，客户端指定超时时间为N秒，但是该请求在服务端实际需要执行M秒(M&gt;N秒)，客户端等的不耐烦了就关闭了
</span></span><span class="line"><span class="cl"># 对于499状态来讲，解决方式是优化后端代码逻辑或者修改nginx参数
</span></span><span class="line"><span class="cl">$ cat nginx.conf
</span></span><span class="line"><span class="cl">proxy_ignore_client_abort    on;
</span></span><span class="line"><span class="cl">$ curl -i -m 3 http://127.0.0.1/hello.php
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 502的实际情况通常是Nginx网关后端的服务器直接宕机了(所以就拿不到上游的响应了)
</span></span><span class="line"><span class="cl"># 当然也有可能是上游服务器真正的执行逻辑超过了上游服务器的超时时间限制(比如php-fpm.conf设置request_terminate_timeout5s，但是实际的业务逻辑需要7s才能完成)，此时上游服务器端出现`业务逻辑超时`，给Nginx网关返回了异常的数据造成的
</span></span><span class="line"><span class="cl"># 502时后端的几种错误日志
</span></span><span class="line"><span class="cl"> recv() failed (104: Connection reset by peer) while reading response header from upstream
</span></span><span class="line"><span class="cl"> upstream prematurely closed connection while reading response header from upstream
</span></span><span class="line"><span class="cl"> connect() failed (111: Connection refused) while connecting to upstream
</span></span><span class="line"><span class="cl"># 整体来说502出现的问题通常是因为后端挂了，或者因为后端负载太高，暂时不可响应
</span></span><span class="line"><span class="cl"># 可以在nginx侧增加proxy_read_timeout来暂时缓解
</span></span><span class="line"><span class="cl">$ cat nginx.conf
</span></span><span class="line"><span class="cl">proxy_read_timeout  20s;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 504的实际情况就是客户端-&gt;Nginx-&gt;Backend，在过程中Nginx需要作为客户端访问Backend服务，但是在Backend还没用执行完成时，Nginx首先超过了自己的客户端超时时间，此时就会出现504的异常(但是对于客户端来说返回什么呢?)
</span></span><span class="line"><span class="cl"># 对于504场景而言，通常的做法就是优化Backend的逻辑，适当减少执行时间；另外也可以适当的增加Nginx作为客户端时的超时时间
</span></span><span class="line"><span class="cl"># 要知道，当Nginx作为客户端时，是以一个Proxy的角色存在的，配置如下参数即可
</span></span><span class="line"><span class="cl">$ cat nginx.conf
</span></span><span class="line"><span class="cl">uwsgi_connect_timeout 5;
</span></span><span class="line"><span class="cl">uwsgi_send_timeout 5;
</span></span><span class="line"><span class="cl">uwsgi_read_timeout 5;
</span></span><span class="line"><span class="cl">fastcgi_read_timeout 5;
</span></span><span class="line"><span class="cl">fastcgi_send_timeout 5;
</span></span><span class="line"><span class="cl">proxy_connect_timeout      90;
</span></span><span class="line"><span class="cl">proxy_send_timeout         90;
</span></span><span class="line"><span class="cl">proxy_read_timeout         90;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="二traefik中诡异的500和502">二、traefik中诡异的500和502</h3>
<h4 id="traefik在kubernetes集群中的部署配置">traefik在Kubernetes集群中的部署配置</h4>
<p>我们当前集群的traefik的配置如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># traefik的configmap配置文件
</span></span><span class="line"><span class="cl">$ cat traefik-config.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: ConfigMap
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: traefik-config
</span></span><span class="line"><span class="cl">  namespace: kube-system
</span></span><span class="line"><span class="cl">data:
</span></span><span class="line"><span class="cl">  traefik.toml: |
</span></span><span class="line"><span class="cl">    defaultEntryPoints = [&#34;http&#34;,&#34;https&#34;]
</span></span><span class="line"><span class="cl">    debug = false
</span></span><span class="line"><span class="cl">    logLevel = &#34;INFO&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    InsecureSkipVerify = true
</span></span><span class="line"><span class="cl">    [entryPoints]
</span></span><span class="line"><span class="cl">      [entryPoints.http]
</span></span><span class="line"><span class="cl">      address = &#34;:80&#34;
</span></span><span class="line"><span class="cl">      compress = true
</span></span><span class="line"><span class="cl">      [entryPoints.https]
</span></span><span class="line"><span class="cl">      address = &#34;:443&#34;
</span></span><span class="line"><span class="cl">        [entryPoints.https.tls]
</span></span><span class="line"><span class="cl">    [web]
</span></span><span class="line"><span class="cl">      address = &#34;:8080&#34;
</span></span><span class="line"><span class="cl">    [kubernetes]
</span></span><span class="line"><span class="cl">    [metrics]
</span></span><span class="line"><span class="cl">      [metrics.prometheus]
</span></span><span class="line"><span class="cl">      buckets=[0.1,0.3,1.2,5.0]
</span></span><span class="line"><span class="cl">      entryPoint = &#34;traefik&#34;
</span></span><span class="line"><span class="cl">    [ping]
</span></span><span class="line"><span class="cl">    entryPoint = &#34;http&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># traefik的DaemonSet配置
</span></span><span class="line"><span class="cl">$ cat traefik-ds-v1.7.16.yaml
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: ServiceAccount
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: traefik-ingress-controller
</span></span><span class="line"><span class="cl">  namespace: kube-system
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">kind: DaemonSet
</span></span><span class="line"><span class="cl">apiVersion: extensions/v1beta1
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: traefik-ingress-controller
</span></span><span class="line"><span class="cl">  namespace: kube-system
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    k8s-app: traefik-ingress-lb
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        k8s-app: traefik-ingress-lb
</span></span><span class="line"><span class="cl">        name: traefik-ingress-lb
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      affinity:
</span></span><span class="line"><span class="cl">        nodeAffinity:
</span></span><span class="line"><span class="cl">          requiredDuringSchedulingIgnoredDuringExecution:
</span></span><span class="line"><span class="cl">            nodeSelectorTerms:
</span></span><span class="line"><span class="cl">            - matchExpressions:
</span></span><span class="line"><span class="cl">              - key: node-role.kubernetes.io/master
</span></span><span class="line"><span class="cl">                operator: DoesNotExist
</span></span><span class="line"><span class="cl">      serviceAccountName: traefik-ingress-controller
</span></span><span class="line"><span class="cl">      terminationGracePeriodSeconds: 30
</span></span><span class="line"><span class="cl">      hostNetwork: true
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - image: traefik:v1.7.16
</span></span><span class="line"><span class="cl">        name: traefik-ingress-lb
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - name: http
</span></span><span class="line"><span class="cl">          containerPort: 80
</span></span><span class="line"><span class="cl">          hostPort: 80
</span></span><span class="line"><span class="cl">        - name: admin
</span></span><span class="line"><span class="cl">          containerPort: 8080
</span></span><span class="line"><span class="cl">        securityContext:
</span></span><span class="line"><span class="cl">          capabilities:
</span></span><span class="line"><span class="cl">            drop:
</span></span><span class="line"><span class="cl">            - ALL
</span></span><span class="line"><span class="cl">            add:
</span></span><span class="line"><span class="cl">            - NET_BIND_SERVICE
</span></span><span class="line"><span class="cl">        args:
</span></span><span class="line"><span class="cl">        - --api
</span></span><span class="line"><span class="cl">        - --kubernetes
</span></span><span class="line"><span class="cl">        - --logLevel=INFO
</span></span><span class="line"><span class="cl">        - --traefikLog.filePath=/logdata/traefik.log
</span></span><span class="line"><span class="cl">        - --configfile=/config/traefik.toml
</span></span><span class="line"><span class="cl">        - --accesslog.filepath=/logdata/access.log
</span></span><span class="line"><span class="cl">        - --accesslog.bufferingsize=100
</span></span><span class="line"><span class="cl">        volumeMounts:
</span></span><span class="line"><span class="cl">        - mountPath: /config
</span></span><span class="line"><span class="cl">          name: config
</span></span><span class="line"><span class="cl">        - mountPath: /logdata
</span></span><span class="line"><span class="cl">          name: access-log
</span></span><span class="line"><span class="cl">      volumes:
</span></span><span class="line"><span class="cl">      - configMap:
</span></span><span class="line"><span class="cl">          name: traefik-config
</span></span><span class="line"><span class="cl">        name: config
</span></span><span class="line"><span class="cl">      - name: access-log
</span></span><span class="line"><span class="cl">        hostPath:
</span></span><span class="line"><span class="cl">          path: /opt/logs/ingress/
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: traefik-ingress-service
</span></span><span class="line"><span class="cl">  namespace: kube-system
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    k8s-app: traefik-ingress-lb
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    k8s-app: traefik-ingress-lb
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">    - protocol: TCP
</span></span><span class="line"><span class="cl">      port: 80
</span></span><span class="line"><span class="cl">      name: web
</span></span><span class="line"><span class="cl">    - protocol: TCP
</span></span><span class="line"><span class="cl">      port: 8080
</span></span><span class="line"><span class="cl">      name: admin
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="python的对外api接口">Python的对外API接口</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 接口对外的ingress
</span></span><span class="line"><span class="cl">$ kubectl  get ingress -n s-data
</span></span><span class="line"><span class="cl">NAME                     HOSTS                    ADDRESS   PORTS   AGE
</span></span><span class="line"><span class="cl">data-api.bgbiao.cn   data-api.bgbiao.cn             80      236d
</span></span><span class="line"><span class="cl">ops.bgbiao.cn       ops.bgbiao.cn                 80      236d
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 测试对外接口
</span></span><span class="line"><span class="cl">$ curl data-api.bgbiao.cn  -i
</span></span><span class="line"><span class="cl">HTTP/1.1 401 Unauthorized
</span></span><span class="line"><span class="cl">Access-Control-Allow-Headers: Content-Type, X-TOKEN
</span></span><span class="line"><span class="cl">Access-Control-Allow-Origin: *
</span></span><span class="line"><span class="cl">Content-Length: 58
</span></span><span class="line"><span class="cl">Content-Type: application/json
</span></span><span class="line"><span class="cl">Vary: Accept-Encoding
</span></span><span class="line"><span class="cl">Date: Sun, 28 Jun 2020 14:55:00 GMT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 接口需要登录，那么我们对登录接口进行压测来模拟问题
</span></span><span class="line"><span class="cl">$ curl -X POST  --data &#39;@/root/login.json&#39; -H &#39;Content-type:application/json&#39; http://data-api.bgbiao.cn/account/users/login/   -i
</span></span><span class="line"><span class="cl">HTTP/1.1 200 OK
</span></span><span class="line"><span class="cl">Access-Control-Allow-Headers: Content-Type, X-TOKEN
</span></span><span class="line"><span class="cl">Access-Control-Allow-Origin: *
</span></span><span class="line"><span class="cl">Content-Length: 250
</span></span><span class="line"><span class="cl">Content-Type: application/json
</span></span><span class="line"><span class="cl">Vary: Accept-Encoding
</span></span><span class="line"><span class="cl">Date: Sun, 28 Jun 2020 14:56:33 GMT
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="诡异的500和502">诡异的500和502</h4>
<p>在服务部署完成后，一切皆正常，但是简单压测后发现服务出现部分请求失败。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 使用ab工具进行压测
</span></span><span class="line"><span class="cl"># 由压测结果可以发现，20个并发共压测200个请求，期间出现了7次失败请求
</span></span><span class="line"><span class="cl">$ ab -c 20 -n 200   -T &#39;application/json&#39; -p /root/login.json http://data-api.bgbiao.cn/account/users/login/
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Benchmarking data-api.bgbiao.cn (be patient)
</span></span><span class="line"><span class="cl">Completed 100 requests
</span></span><span class="line"><span class="cl">Completed 200 requests
</span></span><span class="line"><span class="cl">Finished 200 requests
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Server Software:
</span></span><span class="line"><span class="cl">Server Hostname:        data-api.bgbiao.cn
</span></span><span class="line"><span class="cl">Server Port:            80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Document Path:          /account/users/login/
</span></span><span class="line"><span class="cl">Document Length:        250 bytes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Concurrency Level:      20
</span></span><span class="line"><span class="cl">Time taken for tests:   1.340 seconds
</span></span><span class="line"><span class="cl">Complete requests:      200
</span></span><span class="line"><span class="cl">Failed requests:        7
</span></span><span class="line"><span class="cl">   (Connect: 0, Receive: 0, Length: 7, Exceptions: 0)
</span></span><span class="line"><span class="cl">Write errors:           0
</span></span><span class="line"><span class="cl">Non-2xx responses:      7
</span></span><span class="line"><span class="cl">Total transferred:      91371 bytes
</span></span><span class="line"><span class="cl">Total body sent:        46400
</span></span><span class="line"><span class="cl">HTML transferred:       48387 bytes
</span></span><span class="line"><span class="cl">Requests per second:    149.21 [#/sec] (mean)
</span></span><span class="line"><span class="cl">Time per request:       134.035 [ms] (mean)
</span></span><span class="line"><span class="cl">Time per request:       6.702 [ms] (mean, across all concurrent requests)
</span></span><span class="line"><span class="cl">Transfer rate:          66.57 [Kbytes/sec] received
</span></span><span class="line"><span class="cl">                        33.81 kb/s sent
</span></span><span class="line"><span class="cl">                        100.38 kb/s total
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Connection Times (ms)
</span></span><span class="line"><span class="cl">              min  mean[+/-sd] median   max
</span></span><span class="line"><span class="cl">Connect:        1    1   0.1      1       1
</span></span><span class="line"><span class="cl">Processing:     2  116  27.8    114     179
</span></span><span class="line"><span class="cl">Waiting:        2  116  27.8    114     179
</span></span><span class="line"><span class="cl">Total:          3  117  27.8    116     180
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Percentage of the requests served within a certain time (ms)
</span></span><span class="line"><span class="cl">  50%    116
</span></span><span class="line"><span class="cl">  66%    121
</span></span><span class="line"><span class="cl">  75%    125
</span></span><span class="line"><span class="cl">  80%    129
</span></span><span class="line"><span class="cl">  90%    154
</span></span><span class="line"><span class="cl">  95%    167
</span></span><span class="line"><span class="cl">  98%    173
</span></span><span class="line"><span class="cl">  99%    175
</span></span><span class="line"><span class="cl"> 100%    180 (longest request)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 将压测结果保存到文本中进行简单分析
</span></span><span class="line"><span class="cl"># 简单分析在200个压测请求中，有4个请求失败，分别为2次500错误和2次502错误
</span></span><span class="line"><span class="cl">$ ab -v 10 -c 20 -n 200   -T &#39;application/json&#39; -p /root/login.json http://data-api.bgbiao.cn/account/users/login/  &gt; ab-log.txt
</span></span><span class="line"><span class="cl">$ cat ab-log.txt | grep HTTP | sort| uniq -c
</span></span><span class="line"><span class="cl">    196 HTTP/1.0 200 OK
</span></span><span class="line"><span class="cl">      2 HTTP/1.0 500 Internal Server Error
</span></span><span class="line"><span class="cl">      2 HTTP/1.0 502 Bad Gateway
</span></span><span class="line"><span class="cl">      1 POST /account/users/login/ HTTP/1.0
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="traefik中500和502问题排查">traefik中500和502问题排查</h4>
<p>前面我们提到了在Nginx的场景中的500和502状态码的原因以及相关的解决方式，那么在Kubernetes集群中，traefik起到的作用和Nginx的作用也是相似的。</p>
<p>在开始的时候，我们提到了集群内的traefik的配置信息，对于SRE来讲，任何生产的服务都必须有相关的可观测性数据，因此，我们也默认将traefik的访问日志和进程日志进行了持久化(分别对应<code>access.log和traefik.log</code>)，同时也暴露了traefik的prometheus的metrics接口。</p>
<p>对于上面的压测请求，我们在访问日志里抓到了如下的异常日志:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ tail -f access.log | grep data-api.bgbiao.cn | grep -v &#39;HTTP/1.0&#34; 200&#39;
</span></span><span class="line"><span class="cl">192.168.0.23 - - [28/Jun/2020:14:57:38 +0000] &#34;POST /account/users/login/ HTTP/1.0&#34; 500 21 &#34;-&#34; &#34;ApacheBench/2.3&#34; 122267376 &#34;data-api.bgbiao.cn/&#34; &#34;http://20.0.41.8:8080&#34; 0ms
</span></span><span class="line"><span class="cl">192.168.0.23 - - [28/Jun/2020:14:57:38 +0000] &#34;POST /account/users/login/ HTTP/1.0&#34; 500 21 &#34;-&#34; &#34;ApacheBench/2.3&#34; 122267385 &#34;data-api.bgbiao.cn/&#34; &#34;http://20.0.26.9:8080&#34; 1ms
</span></span><span class="line"><span class="cl">192.168.0.23 - - [28/Jun/2020:14:57:38 +0000] &#34;POST /account/users/login/ HTTP/1.0&#34; 500 21 &#34;-&#34; &#34;ApacheBench/2.3&#34; 122267410 &#34;data-api.bgbiao.cn/&#34; &#34;http://20.0.41.8:8080&#34; 1ms
</span></span><span class="line"><span class="cl">192.168.0.23 - - [28/Jun/2020:14:57:38 +0000] &#34;POST /account/users/login/ HTTP/1.0&#34; 500 21 &#34;-&#34; &#34;ApacheBench/2.3&#34; 122267418 &#34;data-api.bgbiao.cn/&#34; &#34;http://20.0.41.8:8080&#34; 1ms
</span></span><span class="line"><span class="cl">192.168.0.23 - - [28/Jun/2020:14:57:38 +0000] &#34;POST /account/users/login/ HTTP/1.0&#34; 500 21 &#34;-&#34; &#34;ApacheBench/2.3&#34; 122267484 &#34;data-api.bgbiao.cn/&#34; &#34;http://20.0.26.9:8080&#34; 1ms
</span></span><span class="line"><span class="cl">192.168.0.23 - - [28/Jun/2020:14:57:38 +0000] &#34;POST /account/users/login/ HTTP/1.0&#34; 502 11 &#34;-&#34; &#34;ApacheBench/2.3&#34; 122267518 &#34;data-api.bgbiao.cn/&#34; &#34;http://20.0.26.9:8080&#34; 1ms
</span></span><span class="line"><span class="cl">192.168.0.23 - - [28/Jun/2020:14:57:39 +0000] &#34;POST /account/users/login/ HTTP/1.0&#34; 500 21 &#34;-&#34; &#34;ApacheBench/2.3&#34; 122267550 &#34;data-api.bgbiao.cn/&#34; &#34;http://20.0.26.9:8080&#34; 4ms
</span></span><span class="line"><span class="cl">192.168.0.23 - - [28/Jun/2020:15:02:06 +0000] &#34;POST /account/users/login/ HTTP/1.0&#34; 502 11 &#34;-&#34; &#34;ApacheBench/2.3&#34; 122272696 &#34;data-api.bgbiao.cn/&#34; &#34;http://20.0.41.8:8080&#34; 2ms
</span></span><span class="line"><span class="cl">192.168.0.23 - - [28/Jun/2020:15:02:06 +0000] &#34;POST /account/users/login/ HTTP/1.0&#34; 502 11 &#34;-&#34; &#34;ApacheBench/2.3&#34; 122272711 &#34;data-api.bgbiao.cn/&#34; &#34;http://20.0.41.8:8080&#34; 1ms
</span></span><span class="line"><span class="cl">192.168.0.23 - - [28/Jun/2020:15:02:06 +0000] &#34;POST /account/users/login/ HTTP/1.0&#34; 500 21 &#34;-&#34; &#34;ApacheBench/2.3&#34; 122272836 &#34;data-api.bgbiao.cn/&#34; &#34;http://20.0.26.9:8080&#34; 0ms
</span></span><span class="line"><span class="cl">192.168.0.23 - - [28/Jun/2020:15:02:06 +0000] &#34;POST /account/users/login/ HTTP/1.0&#34; 500 21 &#34;-&#34; &#34;ApacheBench/2.3&#34; 122272837 &#34;data-api.bgbiao.cn/&#34; &#34;http://20.0.41.8:8080&#34; 0ms
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，和我们压测结果里失败请求的状态码相同，都是<code>500</code>和<code>502</code>，虽然数量上不止4个，但这暂时不太重要。</p>
<p>通常对于大多数人来讲，在代理层看到500或者502都会下意识的想，肯定是上游服务的问题，不过这种猜测也能很快进行排除，排除的方法基本如下:</p>
<ul>
<li>在压测出现500和502期间，持续去访问上游服务器</li>
<li>使用同样的压测参数直接压上游服务器</li>
<li>将上游服务部署在独立的ECS上并使用同样参数进行压测</li>
</ul>
<p>经过上述三种方式的测试后，我们基本排除了上游服务的问题，因此正式怀疑traefik本身是否有性能或者其他参数上的问题。</p>
<p>修改traefki中的日志级别为<code>DEBUG</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ cat traefik-ds-v1.7.6.yaml
</span></span><span class="line"><span class="cl">....
</span></span><span class="line"><span class="cl">        args:
</span></span><span class="line"><span class="cl">        - --api
</span></span><span class="line"><span class="cl">        - --kubernetes
</span></span><span class="line"><span class="cl">        - --logLevel=DEBUG
</span></span><span class="line"><span class="cl">....
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后在日志中看到如下相关信息:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 500相关的日志
</span></span><span class="line"><span class="cl">time=&#34;2020-06-28T15:35:05Z&#34; level=debug msg=&#34;&#39;500 Internal Server Error&#39; caused by: http: server closed idle connection&#34;
</span></span><span class="line"><span class="cl">time=&#34;2020-06-28T15:35:05Z&#34; level=debug msg=&#34;vulcand/oxy/forward/http: Round trip: http://20.0.26.9:8080, code: 500, Length: 21, duration: 1.486276ms&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 502相关的日志
</span></span><span class="line"><span class="cl">time=&#34;2020-06-28T15:35:05Z&#34; level=debug msg=&#34;&#39;502 Bad Gateway&#39; caused by: EOF&#34;
</span></span><span class="line"><span class="cl">time=&#34;2020-06-28T15:35:05Z&#34; level=debug msg=&#34;vulcand/oxy/forward/http: Round trip: http://20.0.26.9:8080, code: 502, Length: 11, duration: 1.530677ms&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的500信息，大概可以看出来是traefik的服务进程主动关闭了空闲链接导致的，而下面的502是因为EOF，感觉像是没有读取完响应数据，就被断开了，导致traefik返回502。通常这种情况在Nginx中很常见，也很容易调整相关的配置参数(文章开始有提到)，但是traefik的部署模式以及参数调整，还是需要花心思去看相关文档的。</p>
<p>然后在github上去翻traefik相关的issues，发现该问题曾经出现过很多次。</p>
<ul>
<li><a href="https://github.com/containous/traefik/issues/4481">Traefik return 500 internal error - no 500 on backend</a></li>
<li><a href="https://github.com/containous/traefik/issues/3237">Sporadic 502 response only when running through traefik</a></li>
</ul>
<p>一个是500的issues，一个是502的issues，但通常这两个问题都是成双出现的。</p>
<h4 id="500和502问题解决方案">500和502问题解决方案</h4>
<p>在上面第一个issue中提到，traefik在http的反向代理功能中默认开启了http的keep-alive功能，但是python的应用中未开启http的keep-alive，因为我们上面的测试程序其实也是使用的python开发的，先对该参数进行调整。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 在uwsgi.ini中增加keep-alive参数即可
</span></span><span class="line"><span class="cl">$ cat uwsgi.ini
</span></span><span class="line"><span class="cl">[uwsgi]
</span></span><span class="line"><span class="cl">http = 0.0.0.0:8080
</span></span><span class="line"><span class="cl">http-keepalive = 1
</span></span><span class="line"><span class="cl">chdir = /opt/app/
</span></span><span class="line"><span class="cl">wsgi-file = /opt/app/main.py
</span></span><span class="line"><span class="cl">callable = app
</span></span><span class="line"><span class="cl">stats = 0.0.0.0:8081
</span></span><span class="line"><span class="cl">processes = 2
</span></span><span class="line"><span class="cl">threads = 10
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 重启应用后，再次进行压测
</span></span><span class="line"><span class="cl"># 之前出现的502和500错误基本都消失了
</span></span><span class="line"><span class="cl"># 并发200，共1万个请求，失败的请求数为0，总耗时1min(qps才到160😸)
</span></span><span class="line"><span class="cl">$ ab  -c 200 -n 10000   -T &#39;application/json&#39; -p /root/login.json http://data-api.bgbiao.cn/account/users/login/
</span></span><span class="line"><span class="cl">....
</span></span><span class="line"><span class="cl">....
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Concurrency Level:      200
</span></span><span class="line"><span class="cl">Time taken for tests:   59.323 seconds
</span></span><span class="line"><span class="cl">Complete requests:      10000
</span></span><span class="line"><span class="cl">Failed requests:        0
</span></span><span class="line"><span class="cl">Write errors:           0
</span></span><span class="line"><span class="cl">Total transferred:      4670000 bytes
</span></span><span class="line"><span class="cl">Total body sent:        2320000
</span></span><span class="line"><span class="cl">HTML transferred:       2500000 bytes
</span></span><span class="line"><span class="cl">Requests per second:    168.57 [#/sec] (mean)
</span></span><span class="line"><span class="cl">Time per request:       1186.454 [ms] (mean)
</span></span><span class="line"><span class="cl">Time per request:       5.932 [ms] (mean, across all concurrent requests)
</span></span><span class="line"><span class="cl">Transfer rate:          76.88 [Kbytes/sec] received
</span></span><span class="line"><span class="cl">                        38.19 kb/s sent
</span></span><span class="line"><span class="cl">                        115.07 kb/s total
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Connection Times (ms)
</span></span><span class="line"><span class="cl">              min  mean[+/-sd] median   max
</span></span><span class="line"><span class="cl">Connect:        1    3  38.6      1    1035
</span></span><span class="line"><span class="cl">Processing:   101  942 1457.7    857   32684
</span></span><span class="line"><span class="cl">Waiting:      101  942 1457.7    857   32684
</span></span><span class="line"><span class="cl">Total:        102  945 1458.0    861   32685
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># p99达到7.3s
</span></span><span class="line"><span class="cl">Percentage of the requests served within a certain time (ms)
</span></span><span class="line"><span class="cl">  50%    861
</span></span><span class="line"><span class="cl">  66%   1033
</span></span><span class="line"><span class="cl">  75%   1136
</span></span><span class="line"><span class="cl">  80%   1191
</span></span><span class="line"><span class="cl">  90%   1886
</span></span><span class="line"><span class="cl">  95%   2281
</span></span><span class="line"><span class="cl">  98%   4209
</span></span><span class="line"><span class="cl">  99%   7399
</span></span><span class="line"><span class="cl"> 100%  32685 (longest request)
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过对业务层的http的keep-alive参数的开启，来暂时解决了500和502的问题，那能否通过traefik层的参数来优化该问题呢，上面第二个issue中其实也提到了。</p>
<p>即，通过修改traefik的如下几个参数，并重新部署整个traefik集群即可:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 关闭traefik的keep-alive参数，参数默认为200，如果参数为0，则使用go标准库中的DefaultMaxIdleConnsPerHost参数
</span></span><span class="line"><span class="cl"># keep-alive主要是用来复用链接来减少open files的，但是对于大量的短连接来将这种链接复用就可能出现上述情况
</span></span><span class="line"><span class="cl">--maxidleconnsperhost=-1 
</span></span><span class="line"><span class="cl"># 即通过设置重试次数，增加空闲链接的超时时间，增加转发响应的超时时间,默认是0次
</span></span><span class="line"><span class="cl">--retry.attempts=10
</span></span><span class="line"><span class="cl"># 该参数已经替换为--respondingtimeouts.idletimeout参数了，默认为3m0s
</span></span><span class="line"><span class="cl">--idletimeout=60s
</span></span><span class="line"><span class="cl"># 默认是0s
</span></span><span class="line"><span class="cl">--forwardingtimeouts.responseheadertimeout=60s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># traefik 空闲链接超时
</span></span><span class="line"><span class="cl">$ ./traefik --help | grep idletimeout
</span></span><span class="line"><span class="cl">    --idletimeout                                 (Deprecated) maximum amount of time an idle (keep-alive) connection will remain  (default &#34;0s&#34;)
</span></span><span class="line"><span class="cl">    --respondingtimeouts.idletimeout              IdleTimeout is the maximum amount duration an idle (keep-alive) connection will  (default &#34;3m0s&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 响应超时相关参数
</span></span><span class="line"><span class="cl"> $ ./traefik --help | grep respondingtimeouts
</span></span><span class="line"><span class="cl">    --respondingtimeouts                          Timeouts for incoming requests to the Traefik instance                           (default &#34;true&#34;)
</span></span><span class="line"><span class="cl">    --respondingtimeouts.idletimeout              IdleTimeout is the maximum amount duration an idle (keep-alive) connection will  (default &#34;3m0s&#34;)
</span></span><span class="line"><span class="cl">    --respondingtimeouts.readtimeout              ReadTimeout is the maximum duration for reading the entire request, including    (default &#34;0s&#34;)
</span></span><span class="line"><span class="cl">    --respondingtimeouts.writetimeout             WriteTimeout is the maximum duration before timing out writes of the response.   (default &#34;0s&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 转发的超时
</span></span><span class="line"><span class="cl">$ ./traefik --help | grep forwardingtimeouts
</span></span><span class="line"><span class="cl">    --forwardingtimeouts                          Timeouts for requests forwarded to the backend servers                           (default &#34;true&#34;)
</span></span><span class="line"><span class="cl">    --forwardingtimeouts.dialtimeout              The amount of time to wait until a connection to a backend server can be         (default &#34;30s&#34;)
</span></span><span class="line"><span class="cl">    --forwardingtimeouts.responseheadertimeout    The amount of time to wait for a server&#39;s response headers after fully writing   (default &#34;0s&#34;)
</span></span></code></pre></td></tr></table>
</div>
</div><p>最终修改后的traefik的参数如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 可以根据实际情况考虑是否要关闭keep-alive 即增加参数: --maxidleconnsperhost=-1
</span></span><span class="line"><span class="cl">        - --api
</span></span><span class="line"><span class="cl">        - --kubernetes
</span></span><span class="line"><span class="cl">        - --logLevel=INFO
</span></span><span class="line"><span class="cl">        - --traefikLog.filePath=/logdata/traefik.log
</span></span><span class="line"><span class="cl">        - --configfile=/config/traefik.toml
</span></span><span class="line"><span class="cl">        - --accesslog.filepath=/logdata/access.log
</span></span><span class="line"><span class="cl">        - --accesslog.bufferingsize=100
</span></span><span class="line"><span class="cl">        - --forwardingtimeouts.responseheadertimeout=60s
</span></span><span class="line"><span class="cl">        - --respondingtimeouts.idletimeout=180s
</span></span><span class="line"><span class="cl">        - --retry.attempts=10
</span></span><span class="line"><span class="cl">        - --idletimeout=180s
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="三slb中诡异的503">三、SLB中诡异的503</h3>
<p>在发现域名直接解析到traefik节点上不再出现502和500后，我们将traefik的节点挂载到阿里云的内网slb中，但是又开始出现了诡异的503问题。</p>
<p>接入slb后的简单压测情况(内网使用的是免费低配的slb😹)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># client-&gt;ali-slb-&gt;traefik-&gt;pods
</span></span><span class="line"><span class="cl">$ ab -v 10 -c 200 -n 2000   -T &#39;application/json&#39; -p postfile.json http://data-api.soulapp.cn/get_doc &gt; slb-log.txt
</span></span><span class="line"><span class="cl">$ cat slb-log.txt | grep  &#39;HTTP/1.1 200&#39; | wc -l
</span></span><span class="line"><span class="cl">1322
</span></span><span class="line"><span class="cl">$ cat slb-log.txt | grep  &#39;HTTP/1.1 503&#39; | wc -l
</span></span><span class="line"><span class="cl">678
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># client-&gt;traefik-&gt;pods
</span></span><span class="line"><span class="cl">$ ab -v 10 -c 200 -n 2000   -T &#39;application/json&#39; -p postfile.json http://data-api.c.bgbiao.cn/get_doc &gt; traefik-log.txt
</span></span><span class="line"><span class="cl">Completed 200 requests
</span></span><span class="line"><span class="cl">Completed 400 requests
</span></span><span class="line"><span class="cl">Completed 600 requests
</span></span><span class="line"><span class="cl">Completed 800 requests
</span></span><span class="line"><span class="cl">Completed 1000 requests
</span></span><span class="line"><span class="cl">Completed 1200 requests
</span></span><span class="line"><span class="cl">Completed 1400 requests
</span></span><span class="line"><span class="cl">Completed 1600 requests
</span></span><span class="line"><span class="cl">Completed 1800 requests
</span></span><span class="line"><span class="cl">Completed 2000 requests
</span></span><span class="line"><span class="cl">Finished 2000 requests
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ cat traefik-log.txt  | grep  &#39;HTTP/1.0 200&#39; | wc -l
</span></span><span class="line"><span class="cl">2000
</span></span></code></pre></td></tr></table>
</div>
</div><p>后来在阿里云文档中看到如下文档，基本上就是在阿里云的SLB侧对不同规格的SLB做了一定的限流策略，此时会向客户端返回503。</p>
<p><a href="https://help.aliyun.com/knowledge_detail/102765.html?spm=5176.2000002.0.0.1f9641e8ymfAas">阿里云TPS-503</a></p>
<hr>
<p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaexte72s7j31bi0hc418.jpg" alt="公众号"></p>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">BGBiao</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2020-11-01
      
        
        
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content">原创文章，如需转载请注明文章作者和出处<BGBiao>。谢谢！</span>
  </p>
</div>


    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">Reward</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/reward_wechat.png">
        <span>Wechat</span>
      </label>
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/reward_wechat.png">
        <span>Alipay</span>
      </label>
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://bgbiao.top/tags/traefik/">traefik</a>
          <a href="https://bgbiao.top/tags/kubernetes/">kubernetes</a>
          <a href="https://bgbiao.top/tags/http/">http</a>
          <a href="https://bgbiao.top/tags/%E7%8A%B6%E6%80%81%E7%A0%81%E5%BC%82%E5%B8%B8/">状态码异常</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/elasticsearch%E5%AE%B9%E9%87%8F%E7%AE%A1%E7%90%86%E5%AE%9E%E8%B7%B5/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">ElasticSearch容量管理实践</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/golang-version/">
            <span class="next-text nav-default">Golang中处理版本信息</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "BGBiao/comments-bgbiao.top"
            issue-term="pathname"
            theme="github-dark"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:weichuangxxb@qq.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/BGBiao/" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.zhihu.com/people/bgbiao" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>
  
    <a href="https://juejin.cn/user/1556564193589431" rel="me noopener" class="iconfont"
      title="juejin"  target="_blank"
      >
      <svg width="36" height="28" viewBox="0 0 36 28" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M17.5875 6.77268L21.8232 3.40505L17.5875 0.00748237L17.5837 0L13.3555 3.39757L17.5837 6.76894L17.5875 6.77268ZM17.5863 17.3955H17.59L28.5161 8.77432L25.5526 6.39453L17.59 12.6808H17.5863L17.5825 12.6845L9.61993 6.40201L6.66016 8.78181L17.5825 17.3992L17.5863 17.3955ZM17.5828 23.2891L17.5865 23.2854L32.2133 11.7456L35.1768 14.1254L28.5238 19.3752L17.5865 28L0.284376 14.3574L0 14.1291L2.95977 11.7531L17.5828 23.2891Z" fill="#1E80FF"/>
</svg>

    </a>


<a href="https://bgbiao.top/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2022
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        BGBiao
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  











  <script>
    $("#openSearch, #openSearchMobile").click(function(){
      $(".modal-dialog").addClass("visible");
    });

    $("#closeSearch").click(function(){
      $(".modal-dialog").removeClass("visible");
    });

    $(document).click(function(event) {
    
      if (!$(event.target).closest(".modal-content, #openSearch, #openSearchMobile").length) {
        $("body").find(".modal-dialog").removeClass("visible");
      }
    });
  </script>





</body>
</html>
